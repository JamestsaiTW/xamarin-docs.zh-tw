---
title: 容器化的微服務
description: 本章將說明如何使用微服務和容器來建置更靈活、 可調整和可靠的新式雲端應用程式。
ms.prod: xamarin
ms.assetid: 5872ad92-04e0-4f1a-9691-79d5602f5683
ms.technology: xamarin-forms
author: davidbritch
ms.author: dabritch
ms.date: 08/07/2017
ms.openlocfilehash: 33be84bc17f72c8b70d117a0742b001f1f763d3d
ms.sourcegitcommit: 4b402d1c508fa84e4fc3171a6e43b811323948fc
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/23/2019
ms.locfileid: "61300707"
---
# <a name="containerized-microservices"></a>容器化的微服務

開發用戶端-伺服器應用程式導致著重於建置使用每個層中的特定技術的分層式應用程式。 這類應用程式通常稱為主*單體式*應用程式，並封裝到預先調整 尖峰負載的硬體。 此開發方法的主要缺點是，無法輕鬆地向個別的元件，每一層內的元件與測試的成本之間緊密的關聯性。 簡單的更新可以有預料之外的結果上的層，其餘部分，因此應用程式元件的變更需要重新測試，並重新部署其整個層級。

特別是有關在雲端的時代，個別的元件無法輕易地調整。 單體式應用程式包含定義域專屬的功能，並通常除以功能的圖層，例如前端、 商務邏輯和資料存放區。 藉由複製到多部電腦，整個應用程式縮放單體式應用程式，如所示的圖 8-1。

![](containerized-microservices-images/monolithicapp.png "整合型應用程式的調整方法")

**圖 8-1**:整合型應用程式的調整方法

## <a name="microservices"></a>微服務

微服務會提供應用程式開發和部署不同的方法，適合的靈活度、 小數位數和現代化的雲端應用程式的可靠性需求的方法。 微服務應用程式就會分解成獨立的元件，它們共同運作以提供應用程式的整體功能。 詞彙微服務是強調，組成應用程式應該要服務夠小，無法反映獨立考量，以便每個微服務實作單一函式。 此外，每個微服務都具有定義完善的合約，讓其他微服務可以通訊，並與其共用的資料。 微服務的一般範例包括購物車、 清查處理、 購買子系統和付款處理程序。

微服務可以向外延展獨立，相較於巨大的單體式應用程式一起調整。 這表示，特定的功能區域，需要更多處理能力或網路頻寬來支援需求，可以調整而不是不必要地相應放大應用程式的其他區域。 圖 8-2 說明此方法，其中的微服務部署並獨立調整，電腦上建立的服務執行個體。

![](containerized-microservices-images/microservicesapp.png "微服務應用程式調整方法")

**圖 8-2**:微服務應用程式調整方法

微服務向外延展可以近乎即時的可讓應用程式以適應多變的負載。 例如，單一微服務中的應用程式的 web 對向功能可能需要相應放大以處理其他連入流量的應用程式中唯一的微服務。

是有負載平衡、 無狀態與共用外部的資料存放區來儲存永續性資料層應用程式的延展性的傳統模型。 具狀態微服務會管理自己的持續性資料，通常它們被放在伺服器上本機儲存，以避免額外負荷的網路存取和複雜度的跨服務作業。 這可讓資料的最快可以處理，並不需要進行快取系統。 此外，可調整的具狀態微服務通常會分割，請在其執行個體，來管理超出可支援單一伺服器的資料大小和傳輸輸送量之間的資料。

微服務也支援獨立更新。 此微服務之間的鬆散偶合提供快速且可靠的應用程式發展。 獨立的分散式本質上支援輪流更新，只有單一微服務的執行個體的子集會更新在任何指定時間的位置。 因此，如果偵測到問題時，有問題的更新可以回復，才能使用錯誤的程式碼或組態來更新所有執行個體。 同樣地，微服務通常使用結構描述版本控制，讓用戶端會在套用更新時，不論哪一個微服務執行個體正在與通訊時，請參閱版本一致。

因此，微服務應用程式會透過整合型應用程式，有許多優點：

-   每個微服務是相對較小、 容易管理和開發。
-   開發和部署獨立於其他服務每個微服務。
-   每個微服務可以獨立相應放大。 例如，目錄服務或購物籃服務可能需要為相應放大多個已排序的服務。 因此，產生基礎結構會更有效率地耗用資源時相應放大。
-   每個微服務隔離任何問題。 比方說，如果在服務中時，發生問題就只會影響該服務。 其他服務可以繼續處理要求。
-   每個微服務可以使用最新技術。 因為微服務是自主並執行的並行，最新的技術與架構可用，而不是強迫使用單體式應用程式可能使用較舊架構。

不過，微服務架構解決方案也有缺點：

-   選擇如何分割成微服務應用程式可能相當困難，因為每個微服務必須是完全自主、 端對端，包括其資料來源的責任。
-   開發人員必須實作服務間通訊，這會新增至應用程式的複雜性和延遲。
-   通常有多個微服務之間的不可部分完成交易都不可行。 因此，商務需求必須採用微服務之間的最終一致性。
-   在生產環境中，沒有部署和管理許多的獨立服務的系統操作複雜度。
-   直接用戶端與微服務通訊，請難重構的微服務的合約。 例如，經過一段時間如何分割成服務的系統可能需要變更。 單一服務可能會分割成兩個或多個服務，並可能會合併這兩項服務。 當用戶端會直接與微服務通訊時，這項重整的工作可能會中斷用戶端應用程式相容性。

## <a name="containerization"></a>容器化

容器化是在其中應用程式和其相依性，再加上抽象化為部署資訊清單檔案，其環境設定的版本集封裝在一起以測試為一個單位，將容器映像的軟體開發方法和部署至主機的作業系統。

容器是隔離的資源控制的可攜式作業環境，但沒有碰觸其他容器或主機的資源應用程式可以執行。 因此，容器會看起來和作用就像在新安裝的實體電腦或虛擬機器。

如所示的圖 8-3，則需要有容器和虛擬機器之間有許多相似之處。

![](containerized-microservices-images/containersvsvirtualmachines.png "微服務應用程式調整方法")

**圖 8-3**:虛擬機器和容器的比較

容器執行之作業系統、 具有檔案系統，而且可以透過網路存取，如同它是實體或虛擬機器。 不過，容器所使用的概念與技術都與虛擬機器非常不同。 虛擬機器包含應用程式、 必要的相依性和完整的客體作業系統。 容器包括應用程式和其相依性，但與主機作業系統上 （除了特殊的虛擬機器，每個容器內執行 HYPER-V 容器） 做為隔離的處理序執行的其他容器共用作業系統。 因此，容器會共用資源，而且通常需要較少的資源比虛擬機器。

容器導向的開發和部署方法的優點是，它會消除不一致的環境設定和使用它們的問題所引起的問題。 此外，容器會將具現化新的容器，視需要允許快速的應用程式相應增加功能。

建立和使用的容器時的重要概念是：

-   容器主機：實體機器或虛擬機器設定為主機容器。 容器主機將會執行一個或多個容器。
-   容器映像：映像會彼此交互堆疊，分層的檔案系統的聯集所組成，而且是容器的基礎。 映像並沒有狀態，而且它永遠不會變更部署至不同的環境。
-   容器：容器是映像的執行階段執行個體。
-   容器 OS 映像：容器會從映像進行部署。 容器作業系統映像會在可能有多個容器所組成的映像層中的第一道防線。 在容器的作業系統不變，並無法修改。
-   容器存放庫：建立容器映像時，每次將映像和其相依性會儲存在本機儲存機制中。 這些映像可以在容器主機上重複使用多次。 容器映像也可以儲存在公用或私用登錄中，這類[Docker Hub](https://hub.docker.com/)，如此一來，它們可以跨不同的容器主機使用。

企業日漸採用容器時實作微服務架構應用程式，和 Docker 已成為已被採用，大部分的軟體平台及雲端廠商的標準容器實作。

EShopOnContainers 參考應用程式會使用 Docker 來裝載四個容器化的後端微服務，如所示的圖 8-4。

![](containerized-microservices-images/microservicesarchitecture.png "eShopOnContainers 參考應用程式後端微服務")

**圖 8-4**: eShopOnContainers 參考應用程式後端微服務

參考應用程式中的後端服務架構就會分解成多個自發子系統的共同作業的微服務和容器形式。 每個微服務會提供單一區域的功能： 身分識別服務、 目錄服務、 訂購的服務和購物籃服務。

每個微服務有它自己的資料庫，讓它可以與其他微服務完全分離。 必要時，從不同的微服務的資料庫之間的一致性是使用應用程式層級事件來達成。 如需詳細資訊，請參閱 <<c0> [ 微服務之間通訊](#communication_between_microservices)。

如需參考應用程式的詳細資訊，請參閱[.NET 微服務：容器化 .NET 應用程式的架構](https://aka.ms/microservicesebook)。

<a name="communication_between_client_and_microservices" />

## <a name="communication-between-client-and-microservices"></a>用戶端與微服務之間的通訊

EShopOnContainers 的行動裝置應用程式與容器化的後端微服務使用的通訊*直接用戶端與微服務*會顯示在 圖 8-5 中的通訊。

![](containerized-microservices-images/directclienttomicroservicecommunication.png "微服務應用程式調整方法")

**圖 8-5**:直接用戶端對微服務通訊

使用直接用戶端與微服務通訊，行動裝置應用程式會直接透過其公用端點，以不同的 TCP 連接埠，每個微服務的每個微服務提出要求。 在生產環境，端點會通常會對應至微服務的負載平衡器，其將要求分散到可用的執行個體。

> [!TIP]
> 請考慮使用 API 閘道的通訊。 當建置大型且複雜的微服務架構應用程式，但它適合多個小型的應用程式時，用戶端以微服務直接通訊可能會有缺點。 當設計大型微服務架構具有數十個微服務應用程式時，請考慮使用 API 閘道的通訊。 如需詳細資訊，請參閱[.NET 微服務：容器化 .NET 應用程式的架構](https://aka.ms/microservicesebook)。

<a name="communication_between_microservices" />

## <a name="communication-between-microservices"></a>微服務之間的通訊

微服務型應用程式是分散式的系統中，可能執行多部電腦上。 每個服務執行個體通常就是一個處理序。 因此，服務必須互動使用的處理序間的通訊協定，例如 HTTP、 TCP、 進階訊息佇列通訊協定 (AMQP) 或二進位通訊協定，根據每個服務的本質。

微服務-微服務通訊的兩個常見方法是以 HTTP 查詢資料，以及輕量型非同步傳訊當透過多個微服務通訊更新時，基礎 REST 通訊。

時，將變更傳播跨多個微服務，非同步傳訊根據的事件驅動通訊非常重要。 使用此方法時，微服務會在發佈事件時值得注意會發生，例如，當它更新商務實體的項目。 其他微服務會訂閱這些事件。 然後，當微服務收到事件時，它會更新自己的商務實體，接著可能會導致發行更多的事件。 此發行-訂閱功能通常透過事件匯流排。

事件匯流排可讓發行-訂閱微服務，而不需要元件明確知道彼此，如所示的圖 8-6 之間的通訊。

![](containerized-microservices-images/eventbus.png "使用事件匯流排發佈 / 訂閱")

**圖 8-6:** 使用事件匯流排發佈 / 訂閱

應用程式的觀點而言，事件匯流排的只是 「 發佈-訂閱通道會透過介面公開。 不過，事件匯流排實作的方式而有所不同。 例如，RabbitMQ、 Azure 服務匯流排或其他服務匯流排，例如 NServiceBus 和 MassTransit，可以使用事件匯流排實作。 圖 8-7 示範 eShopOnContainers 參考應用程式中使用事件匯流排的方式。

![](containerized-microservices-images/microservicesarchitecturewitheventbus.png "參考應用程式中的非同步事件驅動通訊")

**圖 8-7:** 參考應用程式中的非同步事件驅動通訊

使用 RabbitMQ 實作 eShopOnContainers 事件匯流排提供一個對多非同步發佈 / 訂閱功能。 這表示，發行事件之後, 可以有多個訂閱者接聽相同事件。 圖 8-9 說明這個關聯性。

![](containerized-microservices-images/eventdrivencommunication.png "一對多通訊")

**圖 8-9**:一對多通訊

這個一對多的通訊方法會使用事件來實作跨越多個服務，確保在服務之間的最終一致性的商務交易。 最終一致的交易是由一系列的分散式步驟所組成。 因此，當使用者設定檔微服務收到 UpdateUser 命令時，它會更新使用者的詳細資料，其資料庫中並將 UserUpdated 事件發佈至事件匯流排。 購物籃微服務和訂購微服務都已訂閱接收此事件，並在回應中更新其買方資訊在其各自的資料庫中。

> [!NOTE]
> EShopOnContainers 事件匯流排，使用 RabbitMQ 實作被要僅做概念證明。 針對生產系統，應該考慮替代的事件匯流排實作。

事件匯流排實作的相關資訊，請參閱[.NET 微服務：容器化 .NET 應用程式的架構](https://aka.ms/microservicesebook)。

## <a name="summary"></a>總結

微服務都會提供一種應用程式開發和部署適用於現代化雲端應用程式的靈活度、 小數位數和可靠性需求。 其中一個微服務的主要優點是，它們可以獨立相應放大，這表示，特定的功能區域可以調整需要多個處理電源或網路頻寬來支援需求，而不會不必要地縮放的區域不發生日益增加的需求的應用程式。

容器是隔離的資源控制的可攜式作業環境，但沒有碰觸其他容器或主機的資源應用程式可以執行。 企業日漸採用容器時實作微服務架構應用程式，和 Docker 已成為已被採用，大部分的軟體平台及雲端廠商的標準容器實作。


## <a name="related-links"></a>相關連結

- [下載電子書 (2 Mb PDF)](https://aka.ms/xamarinpatternsebook)
- [eShopOnContainers (GitHub) （範例）](https://github.com/dotnet-architecture/eShopOnContainers)

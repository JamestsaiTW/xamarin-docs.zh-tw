---
title: 建立 Android 服務
description: 本指南會討論 Xamarin.Android 服務，這是允許沒有作用中的使用者介面進行工作的 Android 元件。 服務會在背景中，很多時間的計算，下載檔案，播放音樂，例如執行的工作相當常用等等。 它說明適用於服務的不同案例，並示範如何實作它們，同時執行長時間執行的背景工作以及遠端程序呼叫中提供的介面。
ms.prod: xamarin
ms.assetid: BA371A59-6F7A-F62A-02FC-28253504ACC9
ms.technology: xamarin-android
author: conceptdev
ms.author: crdun
ms.date: 03/19/2018
ms.openlocfilehash: 4ae86ca5fa47169bb5d78eb9d1116e419c23ed6d
ms.sourcegitcommit: 4b402d1c508fa84e4fc3171a6e43b811323948fc
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/23/2019
ms.locfileid: "61012469"
---
# <a name="creating-android-services"></a>建立 Android 服務

_本指南會討論 Xamarin.Android 服務，這是允許沒有作用中的使用者介面進行工作的 Android 元件。服務會在背景中，很多時間的計算，下載檔案，播放音樂，例如執行的工作相當常用等等。它說明適用於服務的不同案例，並示範如何實作它們，同時執行長時間執行的背景工作以及遠端程序呼叫中提供的介面。_

## <a name="android-services-overview"></a>Android 服務概觀

行動裝置應用程式不像桌面應用程式中。 桌上型電腦佈滿大量資源，例如螢幕面積、 記憶體、 儲存空間和已連接的電源供應器，行動裝置不這麼做。 這些條件約束強制執行行動裝置應用程式，以不同的方式。 例如，在行動裝置上的小型螢幕通常表示該只有一個應用程式 （也就是活動） 會顯示一次。 其他活動會移到背景工作，然後推送進入暫停狀態，它們無法在其中執行任何工作。 不過，因為 Android 應用程式位於背景不表示就無法正常運作的應用程式。 

Android 應用程式都至少一個下列四個主要元件組成：_活動_，_廣播接收器_，_內容提供者_，和_Services_。 活動是許多很棒的 Android 應用程式的基石，因為它們提供可讓使用者與應用程式互動的 UI。 不過，就執行並行或背景工作，活動並不一定最佳的選擇。
 
在 Android 中的背景工作的主要機制是_服務_。 Android 服務是設計用來執行一些工作，而不需要使用者介面的元件。 服務可能會下載檔案、 播放音樂，或將篩選套用至映像。 服務也可以用於處理序間通訊 (_IPC_) 之間 Android 應用程式。 例如一個 Android 應用程式可能會使用來自另一個應用程式 music player 服務或應用程式可能會公開至其他應用程式透過服務的資料 （例如個人的連絡資訊）。 

服務和其能夠執行背景工作，是提供順利且流暢的使用者介面的重要。 所有的 Android 應用程式能夠_主執行緒_(也稱為_UI 執行緒_) 上所執行的活動。 若要保護裝置的回應，Android 必須能夠更新使用者介面，以每秒 60 畫面格數的速率。 如果 Android 應用程式在主執行緒中，執行太多的工作，則 Android 將會捨棄畫面，這也會導致出現不穩定的 UI (有時也稱為_janky_)。 這表示 UI 執行緒上執行任何工作應該完成兩個畫面格，大約 16 毫秒 （1 第二個每隔 60 個畫面） 之間的時間範圍中。 

若要解決這個問題，開發人員可能活動使用執行緒來執行某些工作，會封鎖 UI。 不過，這可能會造成問題。 Android 會終結並重新建立活動的多個執行個體，很可能會。 不過，Android，將不會自動終結執行緒，可能會導致記憶體流失。 主要範例是當[裝置旋轉](~/android/app-fundamentals/handling-rotation.md) &ndash; Android 將會嘗試終結活動的執行個體，然後重新建立新的：

![當裝置旋轉時，摧毀該執行個體 1，並建立執行個體 2](images/image-01.png)

這是潛在的記憶體流失&ndash;仍在執行活動的第一個執行個體所建立的執行緒。 如果執行緒擁有活動的第一個執行個體的參考，這會使 Android 從記憶體回收回收物件。 不過，第二個活動執行個體仍會建立 （進而可能會建立新的執行緒）。 輪替中快速地連續數次的裝置，可能會耗盡所有的 RAM，並強制終止整個應用程式，以回收記憶體的 Android。

根據經驗法則，如果要執行的工作應該必須有存在的活動，則服務應該建立執行該工作。 不過，如果工作只適用於活動的內容，然後建立一個執行緒來執行工作可能更適合。 例如，建立剛新增到 相片圖庫應用程式的相片縮圖應可能發生在服務中。 不過，執行緒可能更適合播放音樂，應該在前景中的活動時只聽。

背景工作可分成兩個廣泛的分類：

1. **長時間執行的工作**&ndash;這是正在進行中，直到明確停止為止的工作。 舉例_長時間執行的工作_是串流處理音樂的應用程式或，必須監視收集自感應器資料。 即使應用程式有不可見的使用者介面，必須執行這些工作。
2. **定期工作** &ndash; (有時稱為_作業_) 定期的工作是指屬於相對較短的持續時間 （幾秒鐘），而且依排程執行 (也就是一天一次一週，或可能是只會一次在接下來的 60 秒）。 這個範例會從網際網路下載檔案，或產生縮圖影像。

有四種不同 Android 服務：

* **繫結服務** &ndash; A_繫結服務_是有一些其他元件 （通常是活動） 繫結至該服務。 繫結的服務提供可讓繫結的元件和服務彼此互動的介面。 沒有更多的用戶端繫結至服務之後，Android 會關閉服務。 

* **`IntentService`** &ndash; _`IntentService`_ 的特定子類別`Service`簡化服務建立和使用方式的類別。 `IntentService`旨在處理個別自發的呼叫。 不同於服務，可同時處理多個呼叫，`IntentService`更像是_運作佇列處理器_&ndash;排入佇列的工作是和`IntentService`處理其中每個作業在單一背景工作執行緒上一次。 一般而言，`IntentService`未繫結至活動或片段。 

* **已啟動服務** &ndash; A_已啟動服務_是一項服務，某些其他 Android 元件 （例如活動） 已啟動，並持續在背景執行，直到項目明確告知若要停止的服務。 不同於繫結的服務，啟動的服務並沒有任何直接繫結至它的用戶端。 基於這個理由，請務必設計啟動的服務，讓它們可能會依正常程序重新啟動為必要。

* **混合式服務** &ndash; A_混合式服務_是一項服務具有的特性_已啟動服務_並_繫結服務_。 元件繫結至它或它可能在某些事件會啟動時，可以藉由啟動混合式服務。 用戶端元件可能會或可能未繫結至混合式服務。 混合式服務將會繼續執行，直到明確告知停止，或直到沒有任何繫結至它的多個用戶端。

要使用類型是服務的完全取決於應用程式的需求。 根據經驗法則，`IntentService`或繫結的服務都足以應付大部分工作都必須執行 Android 應用程式，讓喜好設定，應該會提供這些兩種服務類型的其中一個。 `IntentService`是 「 單次 」 工作，例如下載檔案，而需要頻繁互動的活動/片段時，繫結的服務會是適合的理想選擇。 

雖然大部分的服務在背景執行，還有特殊的子類別，稱為_前景服務_。 這是一項服務，來執行一些工作 （例如播放音樂） 的使用者有更高的優先權 （相較於一般的服務）。 

您也可在其自己的處理序中執行 service fabric 相同的裝置上，這有時稱為_遠端服務_或是_放大處理序服務_。 這需要更多的工作，來建立，可用於應用程式需要共用功能，與其他應用程式，但可以在某些情況下，改善應用程式的使用者體驗。 

### <a name="background-execution-limits-in-android-80"></a>Android 8.0 中的背景執行限制

啟動 Android 8.0 （API 層級 26），在 Android 應用程式不再能夠自由地在背景執行。 在前景，當應用程式可以啟動並執行不受限制的服務。 當應用程式移到背景時，Android 會授與應用程式一段時間才能啟動，並使用服務。 一旦經過這段時間，應用程式不會再開始任何服務，並啟動任何服務將會終止。 此時不可能的應用程式可以執行任何工作。 Android 會考量應用程式處於前景，如果符合下列條件之一：

* 沒有可見的活動 （啟動或暫停）。
* 應用程式已啟動前景服務。
* 另一個應用程式位於前景，並且正在使用在背景中經過的應用程式的元件。 這個範例是如果應用程式 A，也就是在幕前，會繫結至所提供的服務應用程式 b。 應用程式 B 再也會被視為在前景，但沒有終止成為在背景中的 android。

有一些情況下，即使應用程式是在背景中，Android 會喚醒應用程式而放寬這些限制在幾分鐘內，允許應用程式執行一些工作：
* 高優先順序應用程式收到 Firebase 雲端訊息。
* 應用程式會收到廣播。 
* 接收應用程式，並執行`PendingIntent`通知回應。

現有的 Xamarin.Android 應用程式可能需要變更執行背景工作，以避免可能發生在 Android 8.0 上的任何問題。 以下是一些實用的替代方案，Android 服務：

* **排程在背景中使用 Android 工作排程器中執行的工作或有[Firebase 作業發送器](~/android/platform/firebase-job-dispatcher.md)** &ndash;這些兩個程式庫可提供用來區隔中的背景工作的應用程式的架構_作業_，離散的工作單位。 應用程式可以然後作業排程與作業系統以及一些準則有關時可以執行此工作。
* **啟動服務，在前景**&ndash;前景服務很適合用於當應用程式時，必須在背景中執行一些工作，但使用者可能需要定期互動與該工作。 前景服務會顯示持續性的通知，讓使用者知道應用程式正在執行背景工作，並也提供監視或工作與互動的方式。 這個範例會向使用者播放 podcast 或可能下載播客影片，以便稍後喜歡 podcasting 應用程式。 
* **使用 Firebase 雲端訊息 (FCM) 的高優先權**&ndash;時 Android 收到高優先順序 FCM 的應用程式時，它會允許該應用程式，以在背景中執行服務的一段時間。 這會是理想的替代方法，讓輪詢的應用程式在背景中為背景服務。 
* **延後到適用於當應用程式會移至前景**&ndash;如果先前的解決方案都可行，則應用程式必須開發自己的方式，暫停及繼續工作，當應用程式則來到前景。

## <a name="related-links"></a>相關連結

* [在 android Oreo 背景執行限制](https://www.youtube.com/watch?v=Pumf_4yjTMc)

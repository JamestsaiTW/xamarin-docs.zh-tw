---
title: 建立 Android 服務
description: 本指南討論 Xamarin.Android 服務，這是 Android 的元件，可讓不含作用中使用者介面進行工作。 服務會耗費大量時間的計算，下載檔案，播放音樂，例如在背景中執行的工作相當常用等等。 它說明適用於服務之不同案例，並顯示如何將它們實作，同時執行長時間執行背景工作，以及遠端程序呼叫中提供的介面。
ms.prod: xamarin
ms.assetid: BA371A59-6F7A-F62A-02FC-28253504ACC9
ms.technology: xamarin-android
author: topgenorth
ms.author: toopge
ms.date: 03/19/2018
ms.openlocfilehash: 2e942d1085822fee935ae0f23f2253f23d49a43d
ms.sourcegitcommit: 945df041e2180cb20af08b83cc703ecd1aedc6b0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/04/2018
---
# <a name="creating-android-services"></a>建立 Android 服務

_本指南討論 Xamarin.Android 服務，這是 Android 的元件，可讓不含作用中使用者介面進行工作。服務會耗費大量時間的計算，下載檔案，播放音樂，例如在背景中執行的工作相當常用等等。它說明適用於服務之不同案例，並顯示如何將它們實作，同時執行長時間執行背景工作，以及遠端程序呼叫中提供的介面。_

## <a name="android-services-overview"></a>Android 的服務概觀

行動裝置應用程式不像桌面應用程式。 桌面佈滿大量資源，例如螢幕面積、 記憶體、 存放裝置空間和已連接的電源供應器，行動裝置不相符。 這些條件約束強制執行行動裝置應用程式，以不同的方式。 例如，行動裝置上的小型螢幕通常表示，只有一個應用程式 （也就是活動） 會顯示一次。 其他活動會移至背景，而且推入進入暫停狀態，它們無法在其中執行任何工作。 不過，因為 Android 應用程式中背景不表示它是不可能的應用程式，即可繼續工作。 

Android 應用程式會啟動在至少一個下列四個主要元件：_活動_，_廣播接收者_，_內容提供者_，和_服務_。 因為它們提供可讓使用者與應用程式互動的 UI，活動是許多很棒的 Android 應用程式的基石。 不過，執行並行或背景工作時，活動不一定是最佳選擇。
 
在 Android 中的背景工作的主要機制是_服務_。 Android 的服務是設計用來執行一些工作，不含使用者介面的元件。 服務可能會下載檔案、 播放音樂，或將篩選套用至映像。 服務也可以用於處理序間通訊 (_IPC_) Android 應用程式之間。 例如一個 Android 應用程式可能會使用來自另一個應用程式的音樂播放機服務或應用程式可能會公開至其他應用程式透過服務的資料 （例如個人的連絡資訊）。 

服務和其執行背景工作的能力是提供順利且流暢的使用者介面非常重要。 所有 Android 應用程式有_主執行緒_(也稱為_UI 執行緒_) 上所執行的活動。 裝置能繼續回應，Android 必須能夠更新速率為 60 秒畫面格數的使用者介面。 如果太多工作，在主執行緒上執行 Android 應用程式，則 Android 將會捨棄畫面，這又會導致出現不穩定的 UI (有時也稱為_janky_)。 這表示 UI 執行緒上執行任何工作應該完成這兩個框架，（1 第二個每隔 60 的畫面格數） 的大約 16 毫秒的時間範圍中。 

若要解決這個問題，開發人員可能會使用執行緒活動中執行某些工作，會封鎖 UI。 不過，這可能會造成問題。 它是 Android 將會損毀，並重新建立多個執行個體的活動很可能。 不過，Android，並不會自動終結執行緒，可能會導致記憶體流失。 基本的使用範例時，[裝置旋轉](~/android/app-fundamentals/handling-rotation.md) &ndash; Android 將會嘗試終結活動的執行個體，然後重新建立新的：

![當裝置旋轉時，會終結 1 執行個體，並建立執行個體 2](images/image-01.png)

這是潛在的記憶體流失&ndash;仍在執行活動的第一個執行個體所建立的執行緒。 如果執行緒有活動的第一個執行個體的參考，這會防止記憶體回收回收物件來 Android。 不過，活動的第二個執行個體仍會建立 （進而可能會建立新的執行緒）。 輪替中快速且連續數次的裝置可能會耗盡所有的 RAM，並強制 Android 終止整個應用程式的回收記憶體。

做為根據經驗法則，如果要執行的工作應該存留期比長活動，然後服務應該在建立執行該工作。 不過，如果工作只適用於活動的內容，然後建立以執行工作的執行緒可能更合適。 例如，建立縮圖相片剛新增至相片圖庫的應用程式應可能發生在服務。 不過，執行緒可能更合適播放應該在前景活動時只聽某些音樂。

背景工作可分成兩個廣泛的分類：

1. **長時間執行的工作**&ndash;這是正在進行中，直到明確停止的工作。 舉例來說，_長時間執行的工作_是串流處理音樂的應用程式或，必須監視從感應器收集的資料。 即使應用程式有沒有可見的使用者介面，必須執行這些工作。
2. **定期工作** &ndash; (有時稱為_作業_) 週期性工作是指屬於相對較短的持續時間 （秒數），而且依排程執行 (也就是一天一次一週或是一次只在接下來的 60 秒）。 此動作的範例，從網際網路下載檔案，或者產生縮圖影像。

有四種不同 Android 服務：

* **繫結服務** &ndash; A_繫結服務_是有某些其他元件 （通常活動） 與它繫結的服務。 繫結的服務提供可讓繫結的元件和服務彼此互動的介面。 沒有更多的用戶端繫結至服務之後，Android 將會關閉服務。 

* **`IntentService`** &ndash; _`IntentService`_是特定子類別`Service`簡化服務建立和使用方式的類別。 `IntentService`要處理個別自發的呼叫。 不同於服務，可以同時處理多個呼叫，`IntentService`則更像_工作佇列處理器_&ndash;工作排和`IntentService`單一工作者執行緒上一次處理一個每項工作。 一般而言，`IntentService`未繫結至活動或片段。 

* **已啟動服務** &ndash; A_已啟動服務_是服務已啟動某些其他 Android 元件 （例如活動），並會在背景中執行進行持續，直到項目明確告知，若要停止服務。 不同於繫結的服務，啟動的服務並沒有直接繫結至它的任何用戶端。 基於這個理由，是設計啟動的服務，讓它們可能會依正常程序重新啟動視。

* **混合式服務** &ndash; A_混合式服務_是一項服務，其特性的_已啟動服務_和_繫結服務_。 元件繫結到它，或某些事件可能會啟動時，可以透過啟動混合式服務。 用戶端元件可能會或可能未繫結至混合式服務。 混合式服務會繼續執行，直到明確告知停止，或沒有與它繫結的多個用戶端。

服務使用哪一種是完全取決於應用程式的需求。 根據經驗法則，請為`IntentService`或繫結的服務是足以應付大部分工作都必須執行 Android 應用程式，因此喜好設定應該指定這些兩種服務類型的其中一個。 `IntentService`是 「 單次 」 工作，例如下載檔案，而需要頻繁互動的活動/片段時，繫結的服務必須是適當的理想選擇。 

在背景中執行大部分的服務，而沒有特殊的子類別，又稱為_前景服務_。 這是執行一些工作 （例如播放音樂） 使用者的指定更高的優先權 （相較於標準的服務） 的服務。 

它也是可以在它本身的處理序中執行服務，在相同的裝置，這有時稱為_遠端服務_或_跨處理序服務_。 這需要更多心力在建立，但是非常適合用於應用程式需要共用功能與其他應用程式，而且可以在某些情況下，改善應用程式的使用者體驗。 

### <a name="background-execution-limits-in-android-80"></a>Android 8.0 中的背景執行限制

從 Android 應用程式不會再開始 Android 8.0 （API 層級 26），能夠自由地在背景中執行。 在前景，當應用程式可以啟動並執行不受限制的服務。 當應用程式移到背景時，Android 將會授與應用程式來啟動及使用服務的時間量。 一旦經過該時間之後，應用程式可以不會再啟動任何服務，並已啟動的任何服務將會終止。 在此點是不可能的應用程式可以執行任何工作。 Android 將應用程式位於前景，如果符合下列條件會列入考量：

* 沒有可見的活動 （啟動或暫停）。
* 應用程式已啟動前景服務。
* 另一個應用程式位於前景，並使用元件，否則會為在背景中的應用程式。 舉例來說，這是應用程式 A，這是在幕前，是否繫結至所提供的服務應用程式的應用程式 B 再也會視為在前景，並不在背景中所終止 android。

有某些情況下，其中，即使應用程式是在背景中，Android 會喚醒應用程式而放寬這些限制的幾分鐘，讓應用程式來執行一些工作：
* 應用程式收到 Firebase 雲端訊息的高優先順序。
* 應用程式接收廣播例如 
* 應用程式收到執行`PendingIntent`以回應通知。

現有的 Xamarin.Android 應用程式可能需要變更執行背景工作，以避免 Android 8.0 上可能發生的任何問題。 以下是一些實用 alterantives Android 的服務：

* **若要使用 Android 的作業排程器在背景中執行的工作排程或[Firebase 作業發送器](~/android/platform/firebase-job-dispatcher.md)** &ndash;這些兩個程式庫提供用來分隔中的背景工作的應用程式的架構_作業_，離散的工作單位。 應用程式然後透過排程以及一些準則作業系統的工作有關時可以執行此工作。
* **啟動服務，在前景**&ndash;前景服務適用於當應用程式時，必須在背景中執行一些工作，以及使用者可能需要定期與該工作互動。 前景服務會顯示持續的通知，以便使用者注意應用程式正在執行背景工作，而且也提供監視或工作與互動的方式。 這個範例是播客播放的使用者，或可能下載播客時段，以便稍後用 podcasting 應用程式。 
* **使用高優先權 Firebase 雲端訊息 (FCM)** &ndash;時 Android 收到高優先權 FCM 的應用程式時，它會允許服務在背景中執行一段時間該應用程式。 這是理想的替代方法，讓背景服務輪詢在背景中的應用程式。 
* **延後的應用程式進入前景工作**&ndash;如果先前的解決方案都可行的則應用程式必須開發自己的方式，暫停及繼續工作，當應用程式移至前景。

## <a name="related-links"></a>相關連結

* [Android Oreo 背景執行限制](https://www.youtube.com/watch?v=Pumf_4yjTMc)